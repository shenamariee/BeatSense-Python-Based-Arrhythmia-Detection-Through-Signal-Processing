<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeatSense: Python-Based Arrhythmia Detection</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for plotting ECG -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle gradient background */
            background-color: #f8fafc;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f5ff 100%);
        }
        
        /* Hide all sections by default */
        .wizard-section {
            display: none;
            min-height: 80vh;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Show the active section */
        .wizard-section.active {
            display: flex;
        }

        /* Simple fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom styles for buttons (New: blue) */
        .btn-primary {
            @apply inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed;
        }
        
        .btn-secondary {
            @apply inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all;
        }
        
        /* Custom styles for file input (New: blue) */
        input[type="file"]::file-selector-button {
            @apply px-4 py-2 mr-4 border border-gray-300 text-sm font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 cursor-pointer transition-all;
        }
        
        /* Styles for the "Choose Feature" cards (New: blue hover) */
        .feature-card {
            @apply flex flex-col items-center p-8 bg-white rounded-lg border border-gray-200 hover:shadow-xl hover:border-blue-300 transition-all cursor-pointer;
        }
        
        /* NEW: Hero gradient from design guide */
        .hero-gradient { 
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); 
        }

        /* NEW: ECG line animation from design guide */
        .ecg-line-animated {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: draw-line 4s ease-out forwards;
        }
        @keyframes draw-line {
            to { stroke-dashoffset: 0; }
        }
        
        /* NEW: Hero button style from user image */
        .btn-hero {
            @apply inline-flex items-center justify-center px-8 py-4 border border-transparent text-lg font-medium rounded-lg shadow-sm text-blue-700 bg-white hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition-all;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Main Wizard Container -->
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col border border-gray-100">

        <!-- Header / Progress Bar (New: blue) -->
        <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center justify-center gap-3">
                <img src="https://i.imgur.com/HQWhsJ1.png" alt="BeatSense Logo" class="w-8 h-8 object-contain">
                <h1 class="text-2xl font-bold text-blue-800 text-center">BeatSense</h1>
            </div>
            <div id="progress-indicator" class="text-center text-base font-medium text-blue-700 mt-2"></div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow p-6 md:p-10" id="main-content-area"> <!-- Added ID for hero section -->

            <!-- SECTION 1: Welcome (NEW: Hero Section from Design Guide) -->
            <section id="section-1" class="wizard-section active flex-col justify-center items-center text-center">
                <!-- This section's padding is removed to allow the hero to fill the space -->
                <!-- We must manually set the min-height here to override the parent's padding -->
                <div class="relative w-full h-full rounded-lg overflow-hidden flex items-center justify-center" style="min-height: 80vh; margin: -2.5rem;"> <!-- Negative margin to fill parent padding -->
                    <!-- Background Gradient -->
                    <div class="absolute inset-0 hero-gradient"></div>
                    
                    <!-- Animated SVG Graph -->
                    <svg class="absolute inset-0 w-full h-full opacity-30" width="800" height="300" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid slice" aria-label="A stylized ECG waveform graph">
                        <defs>
                            <pattern id="grid-minor" width="10" height="10" patternUnits="userSpaceOnUse">
                                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#ffffff" stroke-width="0.2"/>
                            </pattern>
                            <pattern id="grid-major" width="50" height="50" patternUnits="userSpaceOnUse">
                                <rect width="50" height="50" fill="url(#grid-minor)"/>
                                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#ffffff" stroke-width="0.4"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid-major)" />
                        <!-- Hardcoded animated path based on design -->
                        <path class="ecg-line-animated" fill="none" stroke="#ffffff" stroke-width="2"
                            d="M0,150 C40,150 50,150 60,150 L65,145 C70,130 80,80 90,140 S100,220 110,150 L115,145 C120,130 130,150 140,150 L240,150 C250,150 255,145 260,130 C270,80 280,140 290,220 S300,150 310,150 L315,145 C320,130 330,150 340,150 L440,150 C450,150 455,145 460,130 C470,80 480,140 490,220 S500,150 510,150 L515,145 C520,130 530,150 540,150 L640,150 C650,150 655,145 660,130 C670,80 680,140 690,220 S700,150 710,150 L715,145 C720,130 730,150 740,150 L800,150"/>
                    </svg>

                    <!-- Overlay Content -->
                    <div class="relative z-10 p-8">
                        <h2 class="text-5xl font-extrabold text-white mt-4">Welcome to BeatSense</h2>
                        <p class="mt-4 text-xl text-white font-bold">Your advanced solution for Python-based ECG arrhythmia detection.</p>
                        <button id="get-started-btn" class="btn-hero mt-10 shadow-lg">
                            <span>Get Started</span>
                            <!-- Right Arrow Icon -->
                            <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: Introduction & Working Principle -->
            <section id="section-2" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Introduction & How It Works</h2>
                <div class="prose max-w-none text-gray-700">
                    <p>BeatSense is a powerful tool designed to analyze Electrocardiogram (ECG) signals for potential arrhythmias. By leveraging advanced signal processing algorithms in Python, we provide a fast, accessible, and insightful look into cardiac health.</p>
                    <p>Our platform allows you to:</p>
                    <ul class="list-disc pl-5">
                        <li>Analyze your own ECG files (MAT, CSV, TXT).</li>
                        <li>Explore pre-computed results from the renowned MIT-BIH Arrhythmia Database.</li>
                    </ul>
                    <p class="font-semibold">Our analysis pipeline is a multi-step process:</p>
                    <ol class="list-decimal pl-5">
                        <li><strong>Data Loading:</strong> The tool accepts <code>.mat</code>, <code>.csv</code>, or <code>.txt</code> files.</li>
                        <li><strong>Preprocessing:</strong> The raw signal is filtered to remove noise (like baseline wander).</li>
                        <li><strong>R-Peak Detection:</strong> We employ a robust algorithm to accurately identify the R-peaks.</li>
                        <li><strong>Heart Rate Calculation:</strong> The time intervals between R-peaks (RR-intervals) are calculated and converted into a beat-per-minute (BPM) heart rate.</li>
                        <li><strong>Visualization:</strong> The processed signal, detected R-peaks, and analysis results are plotted for your review.</li>
                    </ol>
                </div>
            </section>

            <!-- SECTION 3: Terms and Conditions (New: blue) -->
            <section id="section-3" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Terms & Conditions</h2>
                <div class="prose max-w-none h-64 overflow-y-auto border border-gray-300 rounded-lg p-4 bg-gray-50 text-gray-700">
                    <p><strong>IMPORTANT: For Educational & Research Use Only.</strong></p>
                    <p>BeatSense is NOT a medical device and is NOT intended for medical diagnosis, treatment, or prevention of any disease. The analysis provided by this tool is not a substitute for professional medical advice.</p>
                    <ul class="list-disc pl-5">
                        <li>You will not use this tool for any clinical or diagnostic decision-making.</li>
                        <li>The developers and providers of BeatSense are not liable for any damages arising from the use of this tool.</li>
                        <li>Do not upload any personally identifiable health information (PHI).</li>
                    </ul>
                </div>
                <div class="mt-6 flex items-center">
                    <input id="terms-accept" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="terms-accept" class="ml-2 block text-sm text-gray-900">I have read, understood, and agree to the Terms & Conditions.</label>
                </div>
            </section>

            <!-- SECTION 4: Choose Feature (New: blue) -->
            <section id="section-4" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Choose Your Path</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
                    <!-- Upload Path -->
                    <div id="upload-path-btn" class="feature-card">
                        <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <h3 class="text-xl font-semibold text-gray-900 mt-4">Upload Your Own ECG</h3>
                        <p class="text-gray-600 text-center mt-2">Analyze a <code>.mat</code>, <code>.csv</code>, or <code>.txt</code> file from your device.</p>
                    </div>
                    <!-- Demo Path -->
                    <div id="demo-path-btn" class="feature-card">
                        <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h3 class="text-xl font-semibold text-gray-900 mt-4">Try a Demo Analysis</h3>
                        <p class="text-gray-600 text-center mt-2">Explore pre-computed results from the MIT-BIH Arrhythmia Database.</p>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 5: Patient Info (New: blue) -->
            <section id="section-5" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Patient Information</h2>
                <p class="text-gray-600 mb-6">This information is optional and used for labeling your analysis. It is not stored or transmitted.</p>
                <form id="patient-info-form" class="space-y-4 max-w-lg">
                    <div>
                        <label for="patient-id" class="block text-sm font-medium text-gray-700">Patient ID / Name</label>
                        <input type="text" id="patient-id" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="patient-age" class="block text-sm font-medium text-gray-700">Age</label>
                        <input type="number" id="patient-age" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="patient-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                        <select id="patient-gender" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Prefer not to say</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </section>

            <!-- SECTION 6: Upload Section (New: blue) -->
            <section id="section-6" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Analyze Your Own ECG</h2>
                <p class="text-gray-600 mb-6">Upload your ECG file (<code>.mat</code>, <code>.csv</code>, <code>.txt</code>). Ensure the file contains a single column of raw signal data.</p>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- File Input -->
                    <div class="flex-1">
                        <label for="file-upload" class="block text-sm font-medium text-gray-700">Upload File</label>
                        <input id="file-upload" type="file" class="mt-1 block w-full text-sm text-gray-500 file:cursor-pointer file:border-0 file:rounded-lg file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <!-- Analyze Button -->
                    <div class="flex-shrink-0 pt-6">
                        <button id="upload-analyze-btn" class="btn-primary w-full">Analyze File</button>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 7: Live Demo (Demo Path) (New: blue) -->
            <section id="section-7" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Live Demo: MIT-BIH Database</h2>
                <p class="text-gray-600 mb-6">Explore pre-computed results from the MIT-BIH Arrhythmia Database. Select a record to view its analysis.</p>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Record Selection -->
                    <div class="flex-1">
                        <label for="record-select" class="block text-sm font-medium text-gray-700">Select Record</label>
                        <select id="record-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">-- Choose a record --</option>
                            <option value="100">Record 100</option>
                            <option value="101">Record 101</option>
                            <option value="102">Record 102</option>
                            <option value="103">Record 103</option>
                            <option value="104">Record 104</option>
                            <option value="105">Record 105</option>
                            <option value="106">Record 106</option>
                            <option value="107">Record 107</option>
                            <option value="108">Record 108</option>
                            <option value="109">Record 109</option>
                            <option value="111">Record 111</option>
                            <option value="112">Record 112</option>
                            <option value="113">Record 113</option>
                            <option value="114">Record 114</option>
                            <option value="115">Record 115</option>
                            <option value="116">Record 116</option>
                            <option value="117">Record 117</option>
                            <option value="118">Record 118</option>
                            <option value="119">Record 119</option>
                            <option value="121">Record 121</option>
                            <option value="122">Record 122</option>
                            <option value="123">Record 123</option>
                            <option value="124">Record 124</option>
                            <option value="200">Record 200</option>
                            <option value="201">Record 201</option>
                            <option value="202">Record 202</option>
                            <option value="203">Record 203</option>
                            <option value="205">Record 205</option>
                            <option value="207">Record 207</option>
                            <option value="208">Record 208</option>
                            <option value="209">Record 209</option>
                            <option value="210">Record 210</option>
                            <option value="212">Record 212</option>
                            <option value="213">Record 213</option>
                            <option value="214">Record 214</option>
                            <option value="215">Record 215</option>
                            <option value="217">Record 217</option>
                            <option value="219">Record 219</option>
                            <option value="220">Record 220</option>
                            <option value="221">Record 221</option>
                            <option value="222">Record 222</option>
                            <option value="223">Record 223</option>
                            <option value="228">Record 228</option>
                            <option value="230">Record 230</option>
                            <option value="231">Record 231</option>
                            <option value="232">Record 232</option>
                            <option value="233">Record 233</option>
                            <option value="234">Record 234</option>
                        </select>
                    </div>
                    <!-- Analyze Button -->
                    <div class="flex-shrink-0 pt-6">
                        <button id="analyze-btn" class="btn-primary w-full">Analyze Record</button>
                    </div>
                </div>
            </section>
            
            <!-- SECTION 8: Results and Recommendation (New: blue) -->
            <section id="section-8" class="wizard-section flex-col justify-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Analysis Results & Recommendation</h2>
                
                <div id="analysis-output" class="w-full">
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="text-center p-10 hidden">
                        <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-lg font-medium text-gray-700">Analyzing, please wait...</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="error-message" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <p><strong>Error:</strong> <span id="error-text"></span></p>
                    </div>

                    <!-- Results -->
                    <div id="results-container" class="hidden">
                        
                        <!-- Recommendation Panel -->
                        <div id="recommendation-panel" class="p-4 rounded-lg mb-6 shadow">
                            <h3 class="text-lg font-semibold mb-2 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                                <span id="recommendation-title">Analysis Summary</span>
                            </h3>
                            <p id="recommendation-text" class="text-gray-700"></p>
                        </div>
                        
                        <!-- Chart Container -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 border border-gray-200">
                            <canvas id="ecg-chart" width="400" height="200"></canvas>
                        </div>
                        
                        <!-- Stats (New: blue theme) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-blue-100 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-blue-800">Avg. Heart Rate</h4>
                                <p id="bpm-display" class="text-3xl font-bold text-blue-900">--</p>
                                <span class="text-blue-700">BPM</span>
                            </div>
                            <div class="bg-green-100 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-green-800">Total Beats</h4>
                                <p id="beats-display" class="text-3xl font-bold text-green-900">--</p>
                                <span class="text-green-700">R-Peaks</span>
                            </div>
                            <div class="bg-yellow-100 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-yellow-800">Record Length</h4>
                                <p id="length-display" class="text-3xl font-bold text-yellow-900">--</s</p>
                                <span class="text-yellow-700">Seconds</span>
                            </div>
                        </div>
                        
                        <!-- Beat Classification Table -->
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Beat Classifications</h3>
                            <div class="overflow-x-auto shadow rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beat Type</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody id="class-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Restart Button for Section 8 -->
                <button id="restart-btn" class="btn-secondary mt-8 mx-auto">Analyze Another</button>
                
            </section>

        </div>

        <!-- Footer / Navigation -->
        <footer class="p-4 bg-gray-100 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <button id="prev-btn" class="btn-secondary" disabled>Previous</button>
                <button id="next-btn" class="btn-primary">Next</button>
            </div>
        </footer>
    </div>

    <!-- 
    ====================================================================
    JAVASCRIPT (main.js)
    ====================================================================
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let currentSection = 1;
            let previousSection = 1; 
            const totalSections = 8;
            
            // --- Elements ---
            const sections = document.querySelectorAll('.wizard-section');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const footer = nextBtn.parentElement.parentElement;
            const progressIndicator = document.getElementById('progress-indicator');
            const termsCheckbox = document.getElementById('terms-accept');
            const restartBtn = document.getElementById('restart-btn');
            const getStartedBtn = document.getElementById('get-started-btn');
            const uploadPathBtn = document.getElementById('upload-path-btn');
            const demoPathBtn = document.getElementById('demo-path-btn');
            const mainContentArea = document.getElementById('main-content-area');

            // --- Section Titles (for progress indicator) ---
            const sectionTitles = [
                "Welcome", "Introduction", "Terms & Conditions", "Choose Feature",
                "Patient Info", "Upload File", "Demo Analysis", "Results"
            ];

            // --- Functions ---
            function updateUI(sectionNumber) {
                if (sectionNumber < 1 || sectionNumber > totalSections) return;
                
                previousSection = currentSection;
                currentSection = sectionNumber;
                
                sections.forEach((section, index) => {
                    section.classList.toggle('active', index + 1 === currentSection);
                });

                progressIndicator.textContent = `Step ${currentSection} of ${totalSections}: ${sectionTitles[currentSection - 1]}`;
                
                // NEW: Remove padding for hero section
                if (currentSection === 1) {
                    mainContentArea.classList.remove('p-6', 'md:p-10');
                } else {
                    mainContentArea.classList.add('p-6', 'md:p-10');
                }

                // --- Button/Footer Visibility Logic ---
                footer.classList.remove('hidden');
                nextBtn.style.display = 'inline-flex';
                restartBtn.classList.add('hidden');
                
                switch (currentSection) {
                    case 1: // Welcome
                        prevBtn.disabled = true;
                        footer.classList.add('hidden');
                        break;
                    case 3: // Terms
                        prevBtn.disabled = false;
                        nextBtn.disabled = !termsCheckbox.checked;
                        break;
                    case 4: // Choose Feature
                        prevBtn.disabled = false;
                        footer.classList.add('hidden');
                        break;
                    case 5: // Patient Info
                        prevBtn.disabled = false;
                        nextBtn.disabled = false;
                        break;
                    case 6: // Upload File
                        prevBtn.disabled = false;
                        nextBtn.style.display = 'none';
                        break;
                    case 7: // Demo Analysis
                        prevBtn.disabled = false;
                        nextBtn.style.display = 'none';
                        break;
                    case 8: // Results
                        footer.classList.add('hidden');
                        restartBtn.classList.remove('hidden');
                        break;
                    default:
                        prevBtn.disabled = false;
                        nextBtn.disabled = false;
                }
            }
            
            window.navigateToWizardSection = updateUI;

            function goToNext() {
                let nextSection = currentSection + 1;
                if (currentSection === 3) nextSection = 4;
                if (currentSection === 5) nextSection = 6;
                updateUI(nextSection);
            }
            
            function goToPrev() {
                let prevSection = currentSection - 1;
                if (currentSection === 5) prevSection = 4;
                if (currentSection === 7) prevSection = 4;
                if (currentSection === 8) prevSection = previousSection;
                updateUI(prevSection);
            }

            // --- Event Listeners ---
            nextBtn.addEventListener('click', goToNext);
            prevBtn.addEventListener('click', goToPrev);
            getStartedBtn.addEventListener('click', () => updateUI(2));
            termsCheckbox.addEventListener('change', () => {
                if (currentSection === 3) nextBtn.disabled = !termsCheckbox.checked;
            });
            uploadPathBtn.addEventListener('click', () => updateUI(5));
            demoPathBtn.addEventListener('click', () => updateUI(7));
            restartBtn.addEventListener('click', () => {
                termsCheckbox.checked = false;
                updateUI(4);
S            });

            updateUI(1);
        });
    </script>
    
    <!-- 
    ====================================================================
    JAVASCRIPT (analyze.js)
    ====================================================================
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- State ---
            let ecgChart = null; 
            let isAnalyzing = false;
            
            // --- Global Elements (Section 8) ---
            const outputContainer = document.getElementById('analysis-output');
            const spinner = document.getElementById('loading-spinner');
            const errorMsg = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const resultsContainer = document.getElementById('results-container');
            const chartCanvas = document.getElementById('ecg-chart');
            const bpmDisplay = document.getElementById('bpm-display');
            const beatsDisplay = document.getElementById('beats-display');
            const lengthDisplay = document.getElementById('length-display');
            const classTable = document.getElementById('class-table-body');
            const recommendationPanel = document.getElementById('recommendation-panel');
            const recommendationTitle = document.getElementById('recommendation-title');
            const recommendationText = document.getElementById('recommendation-text');

            // --- Triggers ---
            const demoRecordSelect = document.getElementById('record-select');
            const demoAnalyzeBtn = document.getElementById('analyze-btn');
            const uploadFileInput = document.getElementById('file-upload');
            const uploadAnalyzeBtn = document.getElementById('upload-analyze-btn');

            const BEAT_EXPLANATIONS = {
                'N': 'Normal beat', 'L': 'Left bundle branch block', 'R': 'Right bundle branch block',
                'V': 'Premature ventricular contraction', 'A': 'Atrial premature beat',
                '/': 'Paced beat', 'f': 'Fusion of paced and normal', 'F': 'Fusion of ventricular and normal',
                'j': 'Nodal (junctional) escape', 'E': 'Ventricular escape', 'J': 'Nodal (junctional) premature',
                'e': 'Atrial escape', 'S': 'Supraventricular premature', 'Q': 'Unclassifiable', '?': 'Unknown'
            };

            // --- Functions ---
            function resetAnalysisUI() {
                console.log("Resetting analysis UI...");
                outputContainer.classList.add('hidden');
                spinner.classList.add('hidden');
                errorMsg.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                bpmDisplay.textContent = '--';
                beatsDisplay.textContent = '--';
                lengthDisplay.textContent = '--';
                classTable.innerHTML = '';
                errorText.textContent = '';
                recommendationText.textContent = '';
                if (ecgChart) { ecgChart.destroy(); ecgChart = null; }
                isAnalyzing = false;
                demoAnalyzeBtn.disabled = false;
                uploadAnalyzeBtn.disabled = false;
            }

            function showLoading() {
                isAnalyzing = true;
                outputContainer.classList.remove('hidden');
                spinner.classList.remove('hidden');
                errorMsg.classList.add('hidden');
                resultsContainer.classList.add('hidden');
            }

            async function handleDemoAnalyze() {
                if (isAnalyzing) return;
                const recordName = demoRecordSelect.value;
                if (!recordName) { alert("Please select a record first."); return; }
                demoAnalyzeBtn.disabled = true;
                showLoading();

                try {
                    console.log(`Simulating analysis for record: ${recordName}`);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    const data = simulateAnalysisData(recordName);
                    if (recordName === '108') throw new Error("Simulated load failure for record 108.");
                    displayResults(data);
                    window.navigateToWizardSection(8);
                } catch (error) {
                    displayError(error.message);
                    window.navigateToWizardSection(8);
                } 
            }
            
            async function handleUploadAnalyze() {
                if (isAnalyzing) return;
                const file = uploadFileInput.files[0];
                if (!file) { alert("Please select a file first."); return; }
                uploadAnalyzeBtn.disabled = true;
                showLoading();
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('patient_id', document.getElementById('patient-id').value);
                formData.append('patient_age', document.getElementById('patient-age').value);
                formData.append('patient_gender', document.getElementById('patient-gender').value);

                try {
                    console.log(`Simulating analysis for file: ${file.name}`);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    const data = simulateAnalysisData(file.name);
                    displayResults(data);
                    window.navigateToWizardSection(8);
                } catch (error) {
                    displayError(error.message);
                    window.navigateToWizardSection(8);
                }
            }

            function displayResults(data) {
                spinner.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                bpmDisplay.textContent = data.bpm || '--';
                beatsDisplay.textContent = data.r_peaks ? data.r_peaks.length : '--';
                lengthDisplay.textContent = data.record_length_sec || '--';
                
                classTable.innerHTML = '';
                if (data.beat_counts && Object.keys(data.beat_counts).length > 0) {
                    for (const [symbol, count] of Object.entries(data.beat_counts)) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${BEAT_EXPLANATIONS[symbol] || 'Unknown'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${symbol}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${count}</td>
                        `;
                        classTable.appendChild(row);
                    }
                } else {
                    classTable.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No classification data available.</td></tr>';
                }

                if (data.signal && data.r_peaks) {
                    renderChart(data.signal, data.r_peaks, chartCanvas);
                }
                generateRecommendation(data);
            }
            
            function generateRecommendation(data) {
                let title = "Analysis Complete";
                let text = "The ECG analysis is complete. All metrics appear within normal ranges for this segment.";
                let panelClass = "bg-green-100 border-green-200 text-green-800";
                
                const hasAbnormalBeats = data.beat_counts && (data.beat_counts['V'] || data.beat_counts['A']);
                
                if (data.bpm > 100) {
                    title = "Tachycardia Detected (Fast Heart Rate)";
                    text = `The average heart rate of ${data.bpm} BPM is faster than the typical 60-100 BPM range. This is for educational viewing only.`;
                    panelClass = "bg-yellow-100 border-yellow-300 text-yellow-800";
                } else if (data.bpm < 60) {
                    title = "Bradycardia Detected (Slow Heart Rate)";
                    text = `The average heart rate of ${data.bpm} BPM is slower than the typical 60-100 BPM range. This is for educational viewing only.`;
                    panelClass = "bg-yellow-100 border-yellow-300 text-yellow-800";
                }
                
                if (hasAbnormalBeats) {
                    title = "Abnormal Beats Detected";
                    text = `The analysis identified potential abnormal beat types (e.g., 'V' or 'A'). This is for educational viewing only.`;
                    panelClass = "bg-red-100 border-red-300 text-red-800";
                }
                
                recommendationPanel.className = `p-4 rounded-lg mb-6 shadow ${panelClass}`;
                recommendationTitle.textContent = title;
                recommendationText.textContent = text;
            }

            function displayError(message) {
                spinner.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorText.textContent = message;
                
                recommendationPanel.className = "p-4 rounded-lg mb-6 shadow bg-red-100 border-red-300 text-red-800";
                recommendationTitle.textContent = "Analysis Failed";
                recommendationText.textContent = "Could not complete the analysis. Please check the file or try again.";
            }

            /**
             * Renders the ECG chart using Chart.js.
             * NEW: Color updated to blue.
             */
            function renderChart(signal, rPeaks, canvas) {
                if (ecgChart) ecgChart.destroy();
                const ctx = canvas.getContext('2d');
                const rPeakData = rPeaks.map(index => ({ x: index, y: signal[index] }));
                const labels = Array.from({ length: signal.length }, (_, i) => i);

                ecgChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ECG Signal', 
                                data: signal, 
                                borderColor: 'rgb(59, 130, 246)', // blue-600
                                borderWidth: 1.5, 
                                pointRadius: 0, 
                                tension: 0.1
                            },
                            {
                                type: 'scatter', 
                                label: 'R-Peaks', 
                                data: rPeakData,
                                backgroundColor: 'rgb(239, 68, 68)', // red-500
                                pointRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true, animation: false,
                        scales: {
                            x: { 
                                title: { display: true, text: 'Sample Index' }, 
                                ticks: { maxTicksLimit: 20 },
                                grid: { color: 'rgba(226, 232, 240, 0.7)' }
                            },
                            y: { 
                                title: { display: true, text: 'Amplitude (mV)' },
                                grid: { color: 'rgba(226, 232, 240, 0.7)' }
                            }
                        },
                        plugins: { legend: { position: 'top' }, tooltip: { enabled: true, mode: 'index', intersect: false } },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false }
                    }
                });
            }
            
            // --- SIMULATION FUNCTION ---
            function simulateAnalysisData(recordName) {
                const signalLength = 3000;
                const signal = [];
                const rPeaks = [];
                for (let i = 0; i < signalLength; i++) {
                    let y = Math.sin(i / 20) * 0.5;
                    if (i % 300 === 0) {
                        y = 2.5; rPeaks.push(i); signal.push(y);
                        signal.push(0.5); i++; signal.push(-1.5); i++; signal.push(0.2); i++;
                    } else {
                        signal.push(y + (Math.random() - 0.5) * 0.1);
                    }
                }
                const beat_counts = {'N': 8, 'V': 2};
                if (recordName.includes('101')) {
                    beat_counts['V'] = 0; 
                }
                return {
                    record_name: recordName, bpm: recordName.includes('101') ? 72 : 95, r_peaks: rPeaks,
                    signal: signal.slice(0, 3000), record_length_sec: (signalLength / 360).toFixed(1),
                    beat_counts: beat_counts
                };
            }

            // --- Event Listeners ---
            demoRecordSelect.addEventListener('change', resetAnalysisUI);
            uploadFileInput.addEventListener('change', resetAnalysisUI);
            demoAnalyzeBtn.addEventListener('click', handleDemoAnalyze);
            uploadAnalyzeBtn.addEventListener('click', handleUploadAnalyze);
        });
    </script>
</body>
</html>
