<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeatSense: Python-Based Arrhythmia Detection</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for plotting ECG -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle gradient background */
            background-color: #f8fafc;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f5ff 100%);
        }
        
        /* Hide all sections by default */
        .wizard-section {
            display: none;
            min-height: 80vh; /* Ensure sections fill viewport height */
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Show the active section */
        .wizard-section.active {
            display: flex; /* Use flex to center content */
            flex-direction: column;
            justify-content: center;
        }

        /* Simple fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom styles for Chart.js */
        #ecg-chart-container {
            position: relative;
            width: 100%;
            height: 300px; /* Fixed height for the chart */
        }

        /* Custom styles for progress bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 9999px;
            height: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0;
            height: 100%;
            background-color: #3b82f6; /* Blue */
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center px-4 py-8">

    <div class="w-full max-w-4xl mx-auto">
        <!-- Main Content Card -->
        <main class="bg-white shadow-2xl rounded-2xl p-8 md:p-12 border border-gray-100">
            
            <!-- Header / Title -->
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                    <span class="text-blue-600">Beat</span>Sense
                </h1>
                <p class="text-lg text-gray-500 mt-2">ECG Arrhythmia Detection</p>
            </header>

            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-500 mt-2">
                    <span>Step <span id="current-step-display">1</span> of 8</span>
                    <span id="current-step-name" class="font-medium">Welcome</span>
                </div>
            </div>

            <!-- Wizard Sections Container -->
            <div id="wizard-container">
                <!-- Section 1: Welcome -->
                <section id="section-1" class="wizard-section active">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to BeatSense</h2>
                        <p class="text-gray-600 text-lg mb-8">
                            This tool analyzes ECG signals to detect arrhythmia using a Python-powered backend.
                        </p>
                        <button id="startBtn" class="inline-flex items-center justify-center px-8 py-4 text-lg font-medium rounded-lg border border-transparent bg-blue-600 text-white shadow-lg transition-all duration-200 ease-in-out hover:bg-blue-700 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <span>Get Started</span>
                        </button>
                    </div>
                </section>

                <!-- Section 2: Introduction -->
                <section id="section-2" class="wizard-section">
                    <div class="text-center max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">How It Works</h2>
                        <p class="text-gray-600 mb-4">
                            BeatSense processes your ECG signal through a series of steps:
                        </p>
                        <ol class="list-decimal list-inside text-left space-y-3 text-gray-700">
                            <li><strong>Signal Loading:</strong> Reads your provided ECG data file.</li>
                            <li><strong>Filtering:</strong> Applies a bandpass filter to remove noise.</li>
                            <li><strong>R-Peak Detection:</strong> Identifies the QRS complexes (heartbeats).</li>
                            <li><strong>Beat Classification:</strong> Classifies each beat (e.g., Normal, Ventricular).</li>
                            <li><strong>Report Generation:</strong> Provides a summary and visualization.</li>
                        </ol>
                        <p class="text-gray-600 mt-6 text-sm italic">
                            This application is for demonstration purposes only and is not a substitute for professional medical advice.
                        </p>
                    </div>
                </section>

                <!-- Section 3: Terms & Conditions -->
                <section id="section-3" class="wizard-section">
                    <div class="text-center max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Terms & Conditions</h2>
                        <div class="h-48 overflow-y-scroll border rounded-lg p-4 text-left text-sm text-gray-600 bg-gray-50 mb-6">
                            <p class="font-bold mb-2">1. Not for Medical Use</p>
                            <p>This BeatSense application ("the Service") is provided for informational and educational purposes only. It is not intended for medical diagnosis, monitoring, or treatment. The results generated by the Service are not a substitute for professional medical advice, diagnosis, or treatment.</p>
                            <p class="font-bold mt-4 mb-2">2. Data Privacy</p>
                            <p>We do not store your uploaded ECG data. All processing is done in real-time, and the data is discarded after the analysis is complete and the session ends. By using the Service, you acknowledge and agree to this temporary processing.</p>
                            <p class="font-bold mt-4 mb-2">3. Limitation of Liability</p>
                            <p>The Service is provided "as is" without any warranties. The creators of this application will not be liable for any damages arising from the use or inability to use this Service.</p>
                        </div>
                        <div class="flex items-center justify-center">
                            <input type="checkbox" id="terms-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="terms-checkbox" class="ml-2 block text-sm text-gray-700">
                                I have read and agree to the terms and conditions.
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Choose Feature -->
                <section id="section-4" class="wizard-section">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Choose Your Path</h2>
                        <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                            <!-- Choice 1: Upload -->
                            <div id="upload-choice" class="p-8 border-2 border-gray-200 rounded-xl bg-white shadow-lg cursor-pointer transition-all duration-200 ease-in-out hover:shadow-xl hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" tabindex="0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 16v1a2 2 0 01-2 2H6a2 2 0 01-2-2v-1" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 12l-4-4m0 0l-4 4m4-4v12" />
                                </svg>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">Upload Your Own ECG</h3>
                                <p class="text-gray-600">Analyze a compatible ECG file from your device.</p>
                            </div>
                            <!-- Choice 2: Demo -->
                            <div id="demo-choice" class="p-8 border-2 border-gray-200 rounded-xl bg-white shadow-lg cursor-pointer transition-all duration-200 ease-in-out hover:shadow-xl hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" tabindex="0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0l5-5 5 5" />
                                </svg>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">Try a Demo Analysis</h3>
                                <p class="text-gray-600">Use a pre-loaded sample from the MIT-BIH database.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Section 5: Patient Info -->
                <section id="section-5" class="wizard-section">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Patient Information</h2>
                        <p class="text-center text-gray-600 mb-6">
                            This information will be used to help calibrate the analysis.
                        </p>
                        <form id="patient-info-form" class="space-y-4">
                            <div>
                                <label for="patient-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="patient-name" name="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Jane Doe">
                            </div>
                            <div>
                                <label for="patient-age" class="block text-sm font-medium text-gray-700">Age</label>
                                <input type="number" id="patient-age" name="age" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 65" min="0" max="120">
                            </div>
                            <div>
                                <label for="patient-sex" class="block text-sm font-medium text-gray-700">Sex</label>
                                <select id="patient-sex" name="sex" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="not-specified">Prefer not to say</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Existing Conditions</label>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-center">
                                        <input id="condition-none" name="conditions" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="condition-none" class="ml-2 block text-sm text-gray-700">None</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="condition-afib" name="conditions" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="condition-afib" class="ml-2 block text-sm text-gray-700">Atrial Fibrillation</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="condition-hypertension" name="conditions" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="condition-hypertension" class="ml-2 block text-sm text-gray-700">Hypertension</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Section 6: Upload File -->
                <section id="section-6" class="wizard-section">
                    <div class="text-center max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Upload Your File</h2>
                        <div class="mb-6 space-y-4">
                            <label class="cursor-pointer inline-flex items-center justify-center px-5 py-3 text-base font-medium rounded-lg border border-gray-300 bg-white text-gray-700 transition-all duration-200 ease-in-out hover:bg-gray-50 focus-within:outline-none focus-within:ring-2 focus-within:ring-gray-400 focus-within:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                <span>Choose a file</span>
                                <input type="file" id="upload-file-input" accept=".dat,.csv,.txt,.hea" class="sr-only">
                            </label>
                            <span id="file-name-display" class="block text-sm text-gray-600">No file chosen</span>
                        </div>
                        <button id="analyze-file-btn" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg border border-transparent bg-blue-600 text-white shadow-md transition-all duration-200 ease-in-out hover:bg-blue-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span>Analyze File</span>
                        </button>
                    </div>
                </section>

                <!-- Section 7: Live Demo -->
                <section id="section-7" class="wizard-section">
                    <div class="text-center max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Select a Demo Record</h2>
                        <div class="mb-6">
                            <label for="demo-record-select" class="block text-sm font-medium text-gray-700 mb-2">Choose from the MIT-BIH Arrhythmia Database:</label>
                            <select id="demo-record-select" class="block w-full max-w-xs mx-auto px-4 py-3 text-base text-gray-800 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Select a record...</option>
                                <option value="100">Record 100 (Normal)</option>
                                <option value="101">Record 101 (Normal)</option>
                                <option value="106">Record 106 (Ventricular Bigeminy)</option>
                                <option value="200">Record 200 (Ventricular Tachycardia)</option>
                                <option value="208">Record 208 (Atrial Fibrillation)</option>
                            </select>
                        </div>
                        <button id="analyze-demo-btn" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg border border-transparent bg-blue-600 text-white shadow-md transition-all duration-200 ease-in-out hover:bg-blue-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span>Analyze Record</span>
                        </button>
                    </div>
                </section>

                <!-- Section 8: Results / Analysis -->
                <section id="section-8" class="wizard-section">
                    <div class="w-full">
                        <!-- Loading State -->
                        <div id="loading-state" class="text-center">
                            <div class="flex justify-center items-center mb-4">
                                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Analyzing...</h2>
                            <p class="text-gray-600">This may take a moment. Please wait.</p>
                        </div>

                        <!-- Error State -->
                        <div id="error-state" class="text-center hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h2 class="text-2xl font-bold text-red-700 mb-2">Analysis Failed</h2>
                            <p id="error-message" class="text-gray-600 bg-red-100 border border-red-300 rounded-md p-4"></p>
                        </div>

                        <!-- Results State -->
                        <div id="results-state" class="hidden">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Analysis Results</h2>
                            
                            <!-- Key Metrics -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <div class="bg-blue-50 p-4 rounded-lg shadow-sm text-center">
                                    <div class="text-sm font-medium text-blue-700">Record</div>
                                    <div id="result-record-name" class="text-2xl font-bold text-blue-900">-</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg shadow-sm text-center">
                                    <div class="text-sm font-medium text-green-700">Avg. Heart Rate</div>
                                    <div id="result-bpm" class="text-2xl font-bold text-green-900">-</div>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-lg shadow-sm text-center">
                                    <div class="text-sm font-medium text-indigo-700">Record Length</div>
                                    <div id="result-record-length" class="text-2xl font-bold text-indigo-900">-</div>
                                </div>
                            </div>

                            <!-- Visualizations -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- ECG Plot -->
                                <div class="bg-white p-6 rounded-lg shadow-lg border">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ECG Signal (Lead II)</h3>
                                    <div id="ecg-chart-container">
                                        <canvas id="ecg-chart"></canvas>
                                    </div>
                                </div>
                                <!-- Beat Counts -->
                                <div class="bg-white p-6 rounded-lg shadow-lg border">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Beat Classification</h3>
                                    <div id="beat-counts-container">
                                        <!-- Beat counts will be injected here by JS -->
                                    </div>
                                    <div class="mt-4">
                                        <canvas id="beat-pie-chart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Analyze Another Button -->
                            <div class="text-center mt-10">
                                <button id="analyze-another-btn" class="inline-flex items-center justify-center px-8 py-4 text-lg font-medium rounded-lg border border-transparent bg-blue-600 text-white shadow-lg transition-all duration-200 ease-in-out hover:bg-blue-700 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                                    </svg>
                                    <span>Analyze Another</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer Navigation -->
        <footer id="wizard-footer" class="flex justify-between mt-8">
            <button id="prevBtn" class="inline-flex items-center justify-center px-5 py-3 text-base font-medium rounded-lg border border-gray-300 bg-white text-gray-700 transition-all duration-200 ease-in-out hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Previous</span>
            </button>
            <button id="nextBtn" class="inline-flex items-center justify-center px-5 py-3 text-base font-medium rounded-lg border border-transparent bg-blue-600 text-white transition-all duration-200 ease-in-out hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300 disabled:cursor-not-allowed">
                <span>Next</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </button>
        </footer>
    </div>

    <!-- Main Wizard Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Section & State --
            const sections = document.querySelectorAll('.wizard-section');
            const totalSteps = 8;
            let currentSection = 1;
            let userChoice = null; // 'upload' or 'demo'
            const stepNames = [
                "Welcome", "Introduction", "Terms", "Choose Path", 
                "Patient Info", "Upload File", "Demo Analysis", "Results"
            ];

            // --- Navigation Buttons ---
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const footer = document.getElementById('wizard-footer');
            const startBtn = document.getElementById('startBtn');

            // --- Progress Bar ---
            const progressBar = document.getElementById('progress-bar');
            const stepDisplay = document.getElementById('current-step-display');
            const stepNameDisplay = document.getElementById('current-step-name');

            // --- Section 3: Terms ---
            const termsCheckbox = document.getElementById('terms-checkbox');

            // --- Section 4: Choices ---
            const uploadChoice = document.getElementById('upload-choice');
            const demoChoice = document.getElementById('demo-choice');

            // --- Section 6: Upload ---
            const uploadFileInput = document.getElementById('upload-file-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const analyzeFileBtn = document.getElementById('analyze-file-btn');

            // --- Section 7: Demo ---
            const demoRecordSelect = document.getElementById('demo-record-select');
            const analyzeDemoBtn = document.getElementById('analyze-demo-btn');
            
            // --- Section 8: Results ---
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            const resultsState = document.getElementById('results-state');
            const analyzeAnotherBtn = document.getElementById('analyze-another-btn');
            let ecgChart = null;
            let pieChart = null;

            // --- Main Navigation Function ---
            function navigateTo(sectionNumber) {
                // Ensure sectionNumber is within bounds
                if (sectionNumber < 1) sectionNumber = 1;
                if (sectionNumber > totalSteps) sectionNumber = totalSteps;

                // Handle path branching
                if (userChoice === 'demo' && sectionNumber === 6) {
                    sectionNumber = 7; // Skip Upload, go to Demo
                }
                if (userChoice === 'upload' && sectionNumber === 7) {
                    sectionNumber = 6; // Skip Demo, go to Upload
                }

                currentSection = sectionNumber;
                
                // Hide all sections
                sections.forEach(section => section.classList.remove('active'));
                
                // Show the target section
                const targetSection = document.getElementById(`section-${currentSection}`);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                updateUI();
            }

            // --- UI Update Function ---
            function updateUI() {
                // Update Progress Bar
                let progressPercent = ((currentSection - 1) / (totalSteps - 1)) * 100;
                // Special case for step 5, which is midpoint for both paths
                if (currentSection === 5) progressPercent = 57; // (4 / 7)
                // Path-specific progress
                if (userChoice === 'upload' && currentSection === 6) progressPercent = 71; // (5 / 7)
                if (userChoice === 'demo' && currentSection === 7) progressPercent = 71; // (5 / 7)
                if (currentSection === 8) progressPercent = 100; // Results
                
                progressBar.style.width = `${progressPercent}%`;
                stepDisplay.textContent = currentSection;

                // Determine which step name to show (6 or 7 is path-dependent)
                let currentStepName = stepNames[currentSection - 1];
                if (currentSection === 6 && userChoice === 'demo') {
                    currentStepName = stepNames[6]; // Show "Demo Analysis"
                }
                if (currentSection === 7 && userChoice === 'upload') {
                    currentStepName = stepNames[5]; // Show "Upload File"
                }
                stepNameDisplay.textContent = currentStepName;


                // Reset button visibility
                footer.classList.remove('hidden');
                nextBtn.style.display = 'inline-flex';
                prevBtn.style.display = 'inline-flex';
                nextBtn.disabled = false;
                prevBtn.disabled = false;

                // Handle UI state based on current section
                switch (currentSection) {
                    case 1: // Welcome
                        prevBtn.disabled = true;
                        footer.classList.add('hidden');
                        break;
                    case 2: // Intro
                        prevBtn.disabled = false;
                        break;
                    case 3: // Terms
                        nextBtn.disabled = !termsCheckbox.checked;
                        break;
                    case 4: // Choose Feature
                        prevBtn.disabled = false;
                        nextBtn.style.display = 'none'; // Hide next, but show footer for prev
                        break;
                    case 5: // Patient Info
                        // Reset to proper 'prev' step
                        // (Handled by prevBtn click listener)
                        break;
                    case 6: // Upload File
                        prevBtn.disabled = false;
                        nextBtn.style.display = 'none'; // Use Analyze button
                        break;
                    case 7: // Demo Analysis
                        prevBtn.disabled = false;
                        nextBtn.style.display = 'none'; // Use Analyze button
                        break;
                    case 8: // Results
                        prevBtn.disabled = true; // No going back from results
                        footer.classList.add('hidden'); // Use "Analyze Another"
                        break;
                }
            }

            // --- Analysis & Results Logic ---
            
            function startAnalysis(recordName, isDemo = false) {
                navigateTo(8);
                // 1. Show loading state
                loadingState.classList.remove('hidden');
                resultsState.classList.add('hidden');
                errorState.classList.add('hidden');

                // 2. Simulate API call
                setTimeout(() => {
                    try {
                        let data;
                        if (isDemo) {
                            data = simulateAnalysisData(recordName);
                        } else {
                            // In a real app, you'd get this from an API after file upload
                            data = simulateAnalysisData(recordName || "Uploaded File");
                        }
                        
                        if (!data) throw new Error("No analysis data returned.");

                        // 3. Hide loading, show results
                        loadingState.classList.add('hidden');
                        resultsState.classList.remove('hidden');
                        displayResults(data);

                    } catch (err) {
                        // 4. Handle errors
                        loadingState.classList.add('hidden');
                        errorState.classList.remove('hidden');
                        errorMessage.textContent = err.message || "An unknown error occurred during analysis.";
                    }
                }, 2500); // Simulate network/processing delay
            }

            function displayResults(data) {
                // 1. Populate metrics
                document.getElementById('result-record-name').textContent = data.record_name;
                document.getElementById('result-bpm').textContent = `${data.bpm} BPM`;
                document.getElementById('result-record-length').textContent = `${data.record_length_sec}s`;

                // 2. Populate Beat Counts
                const beatCountsContainer = document.getElementById('beat-counts-container');
                beatCountsContainer.innerHTML = ''; // Clear old data
                const beatColors = { 'N': 'text-green-700', 'V': 'text-red-700', 'S': 'text-yellow-700', 'Q': 'text-gray-700' };
                const beatNames = { 'N': 'Normal', 'V': 'Ventricular', 'S': 'Supraventricular', 'Q': 'Unknown' };

                let beatList = document.createElement('ul');
                beatList.className = 'space-y-2';
                Object.entries(data.beat_counts).forEach(([beat, count]) => {
                    const li = document.createElement('li');
                    li.className = `flex justify-between items-center text-lg ${beatColors[beat] || 'text-gray-700'}`;
                    li.innerHTML = `
                        <span class="font-medium">${beatNames[beat] || beat} (${beat})</span>
                        <span class="font-bold">${count}</span>
                    `;
                    beatList.appendChild(li);
                });
                beatCountsContainer.appendChild(beatList);

                // 3. Render ECG Chart
                if (ecgChart) ecgChart.destroy(); // Destroy old chart
                const chartCtx = document.getElementById('ecg-chart').getContext('2d');
                const chartData = data.signal.map((y, x) => ({ x, y }));
                const rPeakData = data.r_peaks.map(x => ({ x, y: data.signal[x] }));

                ecgChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'ECG Signal',
                                data: chartData,
                                borderColor: 'rgb(59, 130, 246)', // blue-500
                                borderWidth: 1.5,
                                pointRadius: 0,
                                tension: 0.1,
                            },
                            {
                                label: 'R-Peaks',
                                data: rPeakData,
                                pointStyle: 'triangle',
                                rotation: 60,
                                backgroundColor: 'rgb(239, 68, 68)', // red-500
                                pointRadius: 6,
                                showLine: false,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Sample Number' },
                            },
                            y: {
                                title: { display: true, text: 'Amplitude (mV)' }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });

                // 4. Render Pie Chart
                if (pieChart) pieChart.destroy();
                const pieCtx = document.getElementById('beat-pie-chart').getContext('2d');
                pieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.beat_counts).map(b => beatNames[b] || b),
                        datasets: [{
                            data: Object.values(data.beat_counts),
                            backgroundColor: [
                                'rgb(16, 185, 129)', // green-500
                                'rgb(239, 68, 68)',   // red-500
                                'rgb(245, 158, 11)',  // yellow-500
                                'rgb(107, 114, 128)'  // gray-500
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            function resetAnalysisUI() {
                // Called when file input or demo select changes
                // Hides results and shows loading/error states
                resultsState.classList.add('hidden');
                errorState.classList.add('hidden');
                loadingState.classList.remove('hidden'); // Show loading just in case
            }

            // --- Mock Data Generation ---
            // Simulates the JSON output from the Python backend
            function simulateAnalysisData(recordName) {
                const signalLength = 3000;
                const signal = [];
                const rPeaks = [];
                let heartRate = 80; // Default BPM
                let beatType = 'N';

                if (recordName.includes('106')) { heartRate = 120; beatType = 'V'; } // Bigeminy
                if (recordName.includes('200')) { heartRate = 180; beatType = 'V'; } // Tachycardia
                if (recordName.includes('208')) { heartRate = 100; beatType = 'N'; } // AFib (irregular)
                
                const beatInterval = (360 / (heartRate / 60)); // Samples per beat
                const beat_counts = {'N': 0, 'V': 0};

                for (let i = 0; i < signalLength; i++) {
                    let y = 0;
                    // Simulate R-peak
                    if (i % beatInterval < 10) {
                        let peakProgress = (i % beatInterval) / 10;
                        if (peakProgress < 0.5) {
                            y = peakProgress * 2 * (beatType === 'V' ? 3.0 : 2.5); // Taller V-peak
                        } else {
                            y = (1 - peakProgress) * 2 * (beatType === 'V' ? 3.0 : 2.5);
                        }
                    }
                    // Simulate T-wave
                    else if (i % beatInterval > 20 && i % beatInterval < 40) {
                        y = Math.sin(((i % beatInterval) - 20) / 20 * Math.PI) * 0.5;
                    }
                    // Simulate P-wave
                    else if (i % beatInterval > (beatInterval - 30)) {
                        y = Math.sin(((i % beatInterval) - (beatInterval - 30)) / 30 * Math.PI) * 0.2;
                    }
                    
                    // Add R-peak marker
                    if (i % beatInterval === 5) {
                        rPeaks.push(i);
                        // Alternate beats for Bigeminy (106)
                        if (recordName.includes('106')) {
                            beatType = (beatType === 'N') ? 'V' : 'N';
                        }
                        beat_counts[beatType]++;
                    }
                    
                    // Add baseline noise
                    let noise = (Math.random() - 0.5) * 0.1;
                    // Add irregularity for AFib (208)
                    if (recordName.includes('208')) {
                        noise += (Math.random() - 0.5) * 0.2; // More noise
                        if (i % beatInterval === 0) i += (Math.random() - 0.5) * 20; // Irregular interval
                    }

                    signal.push(y + noise);
                }

                if (!recordName.includes('106') && !recordName.includes('200')) {
                    beat_counts['N'] = rPeaks.length;
                    beat_counts['V'] = 0;
                }
                if (recordName.includes('200')) {
                    beat_counts['N'] = 0;
                    beat_counts['V'] = rPeaks.length;
                }

                return {
                    record_name: recordName, 
                    bpm: Math.round(heartRate * (recordName.includes('208') ? (0.8 + Math.random() * 0.4) : 1)), // Fluctuate AFib BPM
                    r_peaks: rPeaks,
                    signal: signal.slice(0, 3000), 
                    record_length_sec: (signalLength / 360).toFixed(1), // Assuming 360 Hz
                    beat_counts: beat_counts
                };
            }

            // --- Event Listeners ---
            nextBtn.addEventListener('click', () => {
                navigateTo(currentSection + 1);
            });

            prevBtn.addEventListener('click', () => {
                // Special handling for branching
                if (currentSection === 6 || currentSection === 7) {
                    navigateTo(5); // Both Upload and Demo go back to Patient Info
                } else if (currentSection === 5) {
                    navigateTo(4); // Patient info goes back to choice
                } else {
                    navigateTo(currentSection - 1);
                }
            });

            startBtn.addEventListener('click', () => navigateTo(2));
            termsCheckbox.addEventListener('change', updateUI);

            // Path choice listeners
            uploadChoice.addEventListener('click', () => {
                userChoice = 'upload';
                navigateTo(5); // Go to patient info
            });
            uploadChoice.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    userChoice = 'upload';
                    navigateTo(5);
                }
            });
            demoChoice.addEventListener('click', () => {
                userChoice = 'demo';
                navigateTo(5); // Go to patient info
            });
            demoChoice.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    userChoice = 'demo';
                    navigateTo(5);
                }
            });


            // Analysis button listeners
            analyzeFileBtn.addEventListener('click', () => {
                const file = uploadFileInput.files[0];
                if (file) {
                    startAnalysis(file.name, false);
                } else {
                    alert('Please select a file first.');
                }
            });

            analyzeDemoBtn.addEventListener('click', () => {
                const record = demoRecordSelect.value;
                if (record) {
                    startAnalysis(record, true);
                } else {
                    alert('Please select a demo record first.');
                }
            });
            
            // New listener for file input display
            uploadFileInput.addEventListener('change', () => {
                if (uploadFileInput.files.length > 0) {
                    fileNameDisplay.textContent = uploadFileInput.files[0].name;
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                }
                resetAnalysisUI();
            });

            demoRecordSelect.addEventListener('change', resetAnalysisUI);

            // Restart listener
            analyzeAnotherBtn.addEventListener('click', () => {
                // Reset state
                userChoice = null;
                if (ecgChart) ecgChart.destroy();
                if (pieChart) pieChart.destroy();
                termsCheckbox.checked = false;
                uploadFileInput.value = null;
                fileNameDisplay.textContent = 'No file chosen';
                demoRecordSelect.value = "";
                // Go to Section 4 (Choice)
                navigateTo(4);
            });

            // --- Initial UI Setup ---
            updateUI();
        });
    </script>
</body>
</html>
