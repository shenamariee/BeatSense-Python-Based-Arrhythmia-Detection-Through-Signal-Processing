<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeatSense: Python-Based Arrhythmia Detection</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f5ff 100%);
        }
        .wizard-section { display: none; min-height: 80vh; animation: fadeIn 0.5s ease-in-out; }
        .wizard-section.active { display: flex; flex-direction: column; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 9999px; height: 10px; overflow: hidden; }
        .progress-bar { width: 0; height: 100%; background-color: #3b82f6; transition: width 0.5s ease-in-out; border-radius: 9999px; }
        #ecg-chart-container { position: relative; width: 100%; height: 400px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center px-4 py-8">

<div class="w-full max-w-4xl mx-auto">
    <main class="bg-white shadow-2xl rounded-2xl p-8 md:p-12 border border-gray-100">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                <span class="text-blue-600">Beat</span>Sense
            </h1>
            <p class="text-lg text-gray-500 mt-2">ECG Arrhythmia Detection</p>
        </header>

        <div class="mb-8">
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-500 mt-2">
                <span>Step <span id="current-step-display">1</span> of 8</span>
                <span id="current-step-name" class="font-medium">Welcome</span>
            </div>
        </div>

        <div id="wizard-container">
            <!-- Sections 1â€“7 remain unchanged -->
            <!-- Section 8: Results / Analysis -->
            <section id="section-8" class="wizard-section">
                <div class="w-full">
                    <div id="loading-state" class="text-center">
                        <div class="flex justify-center items-center mb-4">
                            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Analyzing...</h2>
                        <p class="text-gray-600">This may take a moment. Please wait.</p>
                    </div>

                    <div id="error-state" class="text-center hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-bold text-red-700 mb-2">Analysis Failed</h2>
                        <p id="error-message" class="text-gray-600 bg-red-100 border border-red-300 rounded-md p-4"></p>
                    </div>

                    <div id="results-state" class="hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Analysis Results</h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-blue-50 p-4 rounded-lg shadow-sm text-center">
                                <div class="text-sm font-medium text-blue-700">Record</div>
                                <div id="result-record-name" class="text-2xl font-bold text-blue-900">-</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg shadow-sm text-center">
                                <div class="text-sm font-medium text-green-700">Avg. Heart Rate</div>
                                <div id="result-bpm" class="text-2xl font-bold text-green-900">-</div>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg shadow-sm text-center">
                                <div class="text-sm font-medium text-indigo-700">Record Length</div>
                                <div id="result-record-length" class="text-2xl font-bold text-indigo-900">-</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ECG Plotly Iframe -->
                            <div class="bg-white p-6 rounded-lg shadow-lg border">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">ECG Signal (Lead II)</h3>
                                <div id="ecg-chart-container">
                                    <iframe id="ecg-iframe" src="" width="100%" height="100%" frameborder="0"></iframe>
                                </div>
                            </div>

                            <!-- Beat Counts -->
                            <div class="bg-white p-6 rounded-lg shadow-lg border">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Beat Classification</h3>
                                <div id="beat-counts-container"></div>
                            </div>
                        </div>

                        <div class="text-center mt-10">
                            <button id="analyze-another-btn" class="inline-flex items-center justify-center px-8 py-4 text-lg font-medium rounded-lg border border-transparent bg-blue-600 text-white shadow-lg transition-all duration-200 ease-in-out hover:bg-blue-700 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                                </svg>
                                <span>Analyze Another</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer id="wizard-footer" class="flex justify-between mt-8">
        <button id="prevBtn" class="inline-flex items-center justify-center px-5 py-3 text-base font-medium rounded-lg border border-gray-300 bg-white text-gray-700 transition-all duration-200 ease-in-out hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span>Previous</span>
        </button>
        <button id="nextBtn" class="inline-flex items-center justify-center px-5 py-3 text-base font-medium rounded-lg border border-transparent bg-blue-600 text-white transition-all duration-200 ease-in-out hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-300 disabled:cursor-not-allowed">
            <span>Next</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        </button>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sections = document.querySelectorAll('.wizard-section');
    const totalSteps = 8;
    let currentSection = 1;
    let userChoice = null;
    const stepNames = ["Welcome","Introduction","Terms","Choose Path","Patient Info","Upload File","Demo Analysis","Results"];

    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const footer = document.getElementById('wizard-footer');
    const startBtn = document.getElementById('startBtn');

    const progressBar = document.getElementById('progress-bar');
    const stepDisplay = document.getElementById('current-step-display');
    const stepNameDisplay = document.getElementById('current-step-name');

    const termsCheckbox = document.getElementById('terms-checkbox');
    const uploadChoice = document.getElementById('upload-choice');
    const demoChoice = document.getElementById('demo-choice');

    const uploadFileInput = document.getElementById('upload-file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const analyzeFileBtn = document.getElementById('analyze-file-btn');

    const demoRecordSelect = document.getElementById('demo-record-select');
    const analyzeDemoBtn = document.getElementById('analyze-demo-btn');

    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    const resultsState = document.getElementById('results-state');

    function navigateTo(sectionNumber){
        if(sectionNumber<1) sectionNumber=1;
        if(sectionNumber>totalSteps) sectionNumber=totalSteps;
        if(userChoice==='demo'&&sectionNumber===6) sectionNumber=7;
        if(userChoice==='upload'&&sectionNumber===7) sectionNumber=6;
        currentSection=sectionNumber;
        sections.forEach(s=>s.classList.remove('active'));
        const target=document.getElementById(`section-${currentSection}`);
        if(target) target.classList.add('active');
        updateUI();
    }

    function updateUI(){
        let progressPercent=((currentSection-1)/(totalSteps-1))*100;
        if(currentSection===5) progressPercent=57;
        if(userChoice==='upload'&&currentSection===6) progressPercent=71;
        if(userChoice==='demo'&&currentSection===7) progressPercent=71;
        if(currentSection===8) progressPercent=100;
        progressBar.style.width=`${progressPercent}%`;
        stepDisplay.textContent=currentSection;
        let currentStepName=stepNames[currentSection-1];
        if(currentSection===6&&userChoice==='demo') currentStepName=stepNames[6];
        if(currentSection===7&&userChoice==='upload') currentStepName=stepNames[5];
        stepNameDisplay.textContent=currentStepName;
        footer.classList.remove('hidden');
        nextBtn.style.display='inline-flex';
        prevBtn.style.display='inline-flex';
        nextBtn.disabled=false;
        prevBtn.disabled=false;
        switch(currentSection){
            case 1: prevBtn.disabled=true; footer.classList.add('hidden'); break;
            case 2: prevBtn.disabled=false; break;
            case 3: nextBtn.disabled=!termsCheckbox.checked; break;
            case 4: nextBtn.style.display='none'; break;
            case 6: nextBtn.style.display='none'; break;
            case 7: nextBtn.style.display='none'; break;
            case 8: prevBtn.disabled=true; footer.classList.add('hidden'); break;
        }
    }

    function startAnalysis(recordName,isDemo=false){
        navigateTo(8);
        loadingState.classList.remove('hidden');
        resultsState.classList.add('hidden');
        errorState.classList.add('hidden');

        setTimeout(()=>{
            try{
                let data;
                data=simulateAnalysisData(recordName);
                if(!data) throw new Error("No analysis data returned.");
                loadingState.classList.add('hidden');
                resultsState.classList.remove('hidden');

                document.getElementById('result-record-name').textContent=data.record_name;
                document.getElementById('result-bpm').textContent=`${data.bpm} BPM`;
                document.getElementById('result-record-length').textContent=`${data.record_length_sec}s`;

                const beatCountsContainer=document.getElementById('beat-counts-container');
                beatCountsContainer.innerHTML='';
                const beatColors={N:'text-green-700',V:'text-red-700',S:'text-yellow-700',Q:'text-gray-700'};
                const beatNames={N:'Normal',V:'Ventricular',S:'Supraventricular',Q:'Unknown'};
                let beatList=document.createElement('ul'); beatList.className='space-y-2';
                Object.entries(data.beat_counts).forEach(([beat,count])=>{
                    const li=document.createElement('li');
                    li.className=`flex justify-between items-center text-lg ${beatColors[beat]||'text-gray-700'}`;
                    li.innerHTML=`<span class="font-medium">${beatNames[beat]||beat} (${beat})</span><span class="font-bold">${count}</span>`;
                    beatList.appendChild(li);
                });
                beatCountsContainer.appendChild(beatList);

                // --- Plotly Iframe ---
                const iframe=document.getElementById('ecg-iframe');
                if(isDemo){
                    iframe.src=`web_plots/record${recordName}.html`;
                }else{
                    iframe.src=`uploaded_plots/${recordName}.html`;
                }
            }catch(err){
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent=err.message||"An unknown error occurred during analysis.";
            }
        },500);
    }

    function resetAnalysisUI(){
        resultsState.classList.add('hidden');
        errorState.classList.add('hidden');
        loadingState.classList.remove('hidden');
    }

    function simulateAnalysisData(recordName){
        const signalLength=3000; const rPeaks=[]; let heartRate=80; let beatType='N'; const beat_counts={'N':0,'V':0};
        if(recordName.includes('106')){heartRate=120; beatType='V';}
        if(recordName.includes('200')){heartRate=180; beatType='V';}
        if(recordName.includes('208')){heartRate=100; beatType='N';}
        const numBeats=Math.floor(signalLength/(360/ (heartRate/60))); beat_counts[beatType]=numBeats;
        return {record_name:recordName,bpm:heartRate,r_peaks:rPeaks,signal:[],record_length_sec:(signalLength/360).toFixed(1),beat_counts:beat_counts};
    }

    nextBtn.addEventListener('click',()=>{navigateTo(currentSection+1);});
    prevBtn.addEventListener('click',()=>{
        if(currentSection===6||currentSection===7) navigateTo(5);
        else if(currentSection===5) navigateTo(4);
        else navigateTo(currentSection-1);
    });
    startBtn.addEventListener('click',()=>navigateTo(2));
    termsCheckbox.addEventListener('change',updateUI);
    uploadChoice.addEventListener('click',()=>{userChoice='upload'; navigateTo(5);});
    demoChoice.addEventListener('click',()=>{userChoice='demo'; navigateTo(5);});
    analyzeFileBtn.addEventListener('click',()=>{
        const file=uploadFileInput.files[0];
        if(file) startAnalysis(file.name,false);
        else alert('Please select a file first.');
    });
    analyzeDemoBtn.addEventListener('click',()=>{
        const record=demoRecordSelect.value;
        if(record) startAnalysis(record,true);
        else alert('Please select a demo record first.');
    });
    uploadFileInput.addEventListener('change',()=>{
        fileNameDisplay.textContent=(upload
